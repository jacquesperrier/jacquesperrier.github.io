<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERDICT - Feuille de Temps</title>
    <style>
        :root { --primary: #12263a; --accent: #ffc107; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #0d1b2a; 
            background-image: linear-gradient(180deg, #0d1b2a 0%, #1b263b 100%);
            padding: 10px; min-height: 100vh;
        }
        .container { 
            max-width: 500px; margin: 20px auto; background: #fff; 
            border-radius: 20px; padding: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); 
        }
        .logo-section { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .logo-section h1 { color: var(--primary); font-size: 28px; letter-spacing: 3px; margin: 0; }
        .logo-section p { font-size: 10px; font-weight: bold; color: #666; margin-top: 5px; text-transform: uppercase; }
        .info-card { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--primary); }
        label { display: block; font-weight: bold; margin: 10px 0 5px; font-size: 13px; color: var(--primary); }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; outline: none; }
        .day-box { margin-bottom: 15px; border: 1px solid #eee; border-radius: 15px; overflow: hidden; background: white; }
        .day-label { background: var(--primary); color: white; padding: 10px; font-weight: bold; text-align: center; }
        .day-content { padding: 12px; }
        .time-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .time-row div { flex: 1; }
        textarea { height: 60px; font-size: 14px; resize: none; margin-top: 5px; }
        .total-banner { background: #28a745; color: white; padding: 20px; border-radius: 12px; text-align: center; font-size: 22px; font-weight: bold; margin: 20px 0; }
        .btn-submit { background: var(--accent); color: #000; width: 100%; padding: 20px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 5px 0 #d39e00; }
        .btn-submit:active { transform: translateY(3px); box-shadow: none; }
        .btn-clear { background: #f44336; color: white; width: 100%; padding: 10px; border: none; border-radius: 10px; margin-top: 10px; cursor: pointer; font-size: 12px; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-section">
        <h1>VERDICT</h1>
        <p>Sant√© ‚Ä¢ S√©curit√© ‚Ä¢ IA</p>
    </div>

    <form id="verdictForm">
        <div class="info-card">
            <label>üë§ Nom du Consultant :</label>
            <input type="text" name="Consultant" id="empName" value="Jacques Perrier" required oninput="autoSave()">
            
            <label>üìÖ Semaine du (Lundi) :</label>
            <input type="date" name="Semaine_du" id="wkDate" required onchange="autoSave()">
        </div>

        <div id="formContent"></div>

        <div class="total-banner">TOTAL : <span id="totalHrs">0.00</span>h</div>
        <input type="hidden" name="_total_final" id="hiddenTotal">

        <button type="submit" class="btn-submit" id="btnSend">üöÄ ENVOYER √Ä JACQUES</button>
        <div id="status"></div>
        <button type="button" class="btn-clear" onclick="clearAll()">üóëÔ∏è Effacer la feuille</button>
    </form>
</div>

<script>
const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
const ACTION_URL = "https://formspree.io/f/xdadypze";

function buildForm() {
    let html = '';
    days.forEach((day, i) => {
        html += `
        <div class="day-box">
            <div class="day-label">${day}</div>
            <div class="day-content">
                <label style="margin-top:0">Contrat :</label>
                <select name="${day}_Contrat" id="c${i}" onchange="autoSave()">
                    <option value="CCR">CCR</option>
                    <option value="25903-00">25903-00</option>
                </select>
                <div class="time-row">
                    <div><label>D√©but</label><select name="${day}_Debut" id="s${i}" onchange="calcTotal()">${genHours()}</select></div>
                    <div><label>Fin</label><select name="${day}_Fin" id="e${i}" onchange="calcTotal()">${genHours()}</select></div>
                </div>
                <textarea name="${day}_Description" id="n${i}" placeholder="Notes sur le mandat..." oninput="autoSave()"></textarea>
            </div>
        </div>`;
    });
    document.getElementById('formContent').innerHTML = html;
}

function genHours() {
    let h = '<option value="">--:--</option>';
    for(let i=0; i<24; i++) {
        for(let m=0; m<60; m+=30) {
            let t = (i<10?'0'+i:i)+':'+(m<10?'0'+m:m);
            h += `<option value="${t}">${t}</option>`;
        }
    }
    return h;
}

function calcTotal() {
    let total = 0;
    days.forEach((_, i) => {
        let start = document.getElementById(`s${i}`).value;
        let end = document.getElementById(`e${i}`).value;
        if(start && end) {
            let s = start.split(':'), e = end.split(':');
            let diff = (parseInt(e[0])*60 + parseInt(e[1])) - (parseInt(s[0])*60 + parseInt(s[1]));
            if(diff < 0) diff += 1440;
            total += diff/60;
        }
    });
    document.getElementById('totalHrs').textContent = total.toFixed(2);
    document.getElementById('hiddenTotal').value = total.toFixed(2) + " h";
    autoSave();
}

function autoSave() {
    const data = {
        n: document.getElementById('empName').value,
        d: document.getElementById('wkDate').value,
        vals: days.map((_, i) => ({
            c: document.getElementById(`c${i}`).value,
            s: document.getElementById(`s${i}`).value,
            e: document.getElementById(`e${i}`).value,
            txt: document.getElementById(`n${i}`).value
        }))
    };
    localStorage.setItem('verdict_cache', JSON.stringify(data));
}

function clearAll() {
    if(confirm("Effacer toutes les donn√©es ?")) {
        localStorage.removeItem('verdict_cache');
        location.reload();
    }
}

function loadCache() {
    const now = new Date();
    const day = now.getDay();
    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(now.setDate(diff)).toISOString().split('T')[0];
    document.getElementById('wkDate').value = monday;

    const cached = localStorage.getItem('verdict_cache');
    if(cached) {
        const data = JSON.parse(cached);
        if(data.n) document.getElementById('empName').value = data.n;
        if(data.d) document.getElementById('wkDate').value = data.d;
        data.vals.forEach((v, i) => {
            if(document.getElementById(`s${i}`)) {
                document.getElementById(`c${i}`).value = v.c || 'CCR';
                document.getElementById(`s${i}`).value = v.s;
                document.getElementById(`e${i}`).value = v.e;
                document.getElementById(`n${i}`).value = v.txt;
            }
        });
        calcTotal();
    }
}

document.getElementById("verdictForm").onsubmit = async (e) => {
    e.preventDefault();
    const status = document.getElementById("status");
    const btn = document.getElementById("btnSend");
    btn.disabled = true;
    status.innerHTML = "‚è≥ Envoi en cours...";
    
    const formData = new FormData(e.target);
    try {
        const response = await fetch(ACTION_URL, {
            method: 'POST',
            body: formData,
            headers: { 'Accept': 'application/json' }
        });
        if (response.ok) {
            status.innerHTML = "‚úÖ Envoy√© avec succ√®s !";
            status.style.color = "green";
            alert("Jacques va recevoir ta feuille par courriel.");
        } else {
            throw new Error();
        }
    } catch {
        status.innerHTML = "‚ùå Erreur d'envoi.";
        status.style.color = "red";
        btn.disabled = false;
    }
};

window.onload = () => { buildForm(); loadCache(); };
</script>
</body>
</html>
